<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
  <h1>Видео верификация</h1>
  <video id="webcam" width="640" height="480" autoplay></video>
  <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
  <div id="verification_messages"></div>

  <div>
    <button id="captureFaceBtn">Заснеми лице</button>
    <button id="captureFrontDocBtn">Заснеми предна страна на документ</button>
    <button id="captureBackDocBtn">Заснеми задна страна на документ</button>
  </div>

  <script>
    const video = document.getElementById('webcam');
    const canvas = document.getElementById('canvas');
    const verificationMessages = document.getElementById('verification_messages');
    const context = canvas.getContext('2d');
    const captureFaceBtn = document.getElementById('captureFaceBtn');
    const captureFrontDocBtn = document.getElementById('captureFrontDocBtn');
    const captureBackDocBtn = document.getElementById('captureBackDocBtn');
    let stream;
    let socket;
    let capturingInterval;

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(function(s) {
        stream = s;
        video.srcObject = stream;
        startWebSocket();
      })
      .catch(function(err) {
        console.error("Грешка при достъп до камерата: ", err);
        verificationMessages.innerText = "Няма достъп до камерата.";
      });

    function startWebSocket() {
      socket = new WebSocket('ws://' + window.location.host + '/ws/verification/');

      socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.error) {
          verificationMessages.innerText = "Грешка: " + data.error;
        }
        if (data.face_detected !== undefined && data.liveness_detected !== undefined) {
          verificationMessages.innerText = `Разпознато лице: ${data.face_detected ? 'Да' : 'Не'}, Движение (жив човек - опростено): ${data.liveness_detected ? 'Да' : 'Не'}`;
        }
        if (data.verification_status) {
          verificationMessages.innerText = data.verification_status;
          stopCapture();
          stopCamera();
          window.location.href = "{% url 'verification_status' %}";
        }
        if (data.document_data_front) {
          verificationMessages.innerText += "\nДанни от предна страна: " + JSON.stringify(data.document_data_front);
          // Може да се съхрани в локално хранилище или да се изпрати към сървъра
        }
        if (data.document_data_back) {
          verificationMessages.innerText += "\nДанни от задна страна: " + JSON.stringify(data.document_data_back);
          // Може да се съхрани в локално хранилище или да се изпрати към сървъра
        }
      };

      socket.onclose = function(e) {
        console.error('WebSocket връзката е затворена неочаквано');
        verificationMessages.innerText = "Връзката със сървъра за верификация е прекъсната.";
        stopCapture();
        stopCamera();
      };

      socket.onopen = function(e) {
        // Вече не стартираме автоматично заснемане на кадри за лице
        verificationMessages.innerText = "Готов за верификация. Следвайте инструкциите на екрана.";
      };
    }

    captureFaceBtn.addEventListener('click', function() {
      captureAndSend('face');
      verificationMessages.innerText = "Изпращане на кадър за верификация на лице...";
    });

    captureFrontDocBtn.addEventListener('click', function() {
      captureAndSend('document_front');
      verificationMessages.innerText = "Заснемане и изпращане на предна страна на документ...";
    });

    captureBackDocBtn.addEventListener('click', function() {
      captureAndSend('document_back');
      verificationMessages.innerText = "Заснемане и изпращане на задна страна на документ...";
    });

    function captureAndSend(type) {
      context.drawImage(video, 0, 0, 640, 480);
      const imageDataURL = canvas.toDataURL('image/jpeg', 0.8);
      if (socket.readyState === WebSocket.OPEN) {
        const message = { 'type': type, 'image': imageDataURL };
        socket.send(JSON.stringify(message));
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
    }

    window.onbeforeunload = function() {
      stopCamera();
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close();
      }
    };
  </script>
</body>
</html>